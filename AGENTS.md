# glance-bilibil é¡¹ç›®æ–‡æ¡£

> é¡¹ç›®çŸ¥è¯†åº“ - ä¸º AI Agents å’Œå¼€å‘è€…æä¾›å®Œæ•´é¡¹ç›®ä¸Šä¸‹æ–‡

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

glance-bilibil æ˜¯ä¸€ä¸ªä¸º [glance](https://github.com/glanceapp/glance) å¼€å‘çš„ Bilibili è§†é¢‘æ‰©å±•æ’ä»¶ã€‚æ”¯æŒé…ç½®å¤šä¸ª UP ä¸»ï¼ŒæŒ‰æ—¶é—´æ’åºæ±‡æ€»æ˜¾ç¤ºæœ€æ–°è§†é¢‘ã€‚

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### åˆ†å±‚è®¾è®¡
```
Glance çœ‹æ¿
    â†“ HTTP GET /videos
glance-bilibil (HTTP Server)
    â”œâ”€â”€ API å±‚ (handler.go) - HTTP è·¯ç”±
    â”œâ”€â”€ æœåŠ¡å±‚ (video_service.go) - å¹¶å‘è·å–ã€æ’åºæ±‡æ€»
    â”œâ”€â”€ å¹³å°å±‚ (bilibili.go) - Bilibili API å®¢æˆ·ç«¯
    â”‚   â””â”€â”€ wbi.go - WBI ç­¾å
    â”œâ”€â”€ é…ç½®å±‚ (config.go) - é…ç½®åŠ è½½
    â””â”€â”€ æ¨¡å‹å±‚ (models.go) - æ•°æ®ç»“æ„
    â†“ REST API
Bilibili API
```

### æ ¸å¿ƒæ•°æ®æ¨¡å‹
```go
// è§†é¢‘ä¿¡æ¯ - internal/models/models.go
type Video struct {
    Title        string    // è§†é¢‘æ ‡é¢˜
    ThumbnailUrl string    // ç¼©ç•¥å›¾
    Url          string    // è§†é¢‘é“¾æ¥
    Author       string    // UP ä¸»åç§°
    AuthorUrl    string    // UP ä¸»ä¸»é¡µ
    TimePosted   time.Time // å‘å¸ƒæ—¶é—´
    Duration     string    // æ—¶é•¿
    PlayCount    int       // æ’­æ”¾é‡
    Bvid         string    // BV å·
}
```

---

## âš™ï¸ é…ç½®ä¸éƒ¨ç½²

### é…ç½®æ–‡ä»¶ (`config/config.json`)
```json
{
  "channels": [
    { "mid": "946974", "name": "å½±è§†é£“é£" },
    { "mid": "163637592", "name": "è€å¸ˆå¥½æˆ‘å«ä½•åŒå­¦" },
    { "mid": "25876945", "name": "æå®¢æ¹¾Geekerwan" }
  ]
}
```

**å‘½ä»¤è¡Œå‚æ•°**ï¼š
- `-port`: HTTP æœåŠ¡ç«¯å£ï¼ˆé»˜è®¤ `8082`ï¼‰
- `-limit`: é»˜è®¤æ˜¾ç¤ºè§†é¢‘æ•°é‡ï¼ˆé»˜è®¤ `25`ï¼‰
- `-config`: é…ç½®æ–‡ä»¶è·¯å¾„ï¼ˆé»˜è®¤ `./config/config.json`ï¼‰

**ç¯å¢ƒå˜é‡**ï¼š
- `CONFIG_PATH`: é…ç½®æ–‡ä»¶è·¯å¾„ï¼ˆé»˜è®¤ `./config/config.json`ï¼‰

### Glance é›†æˆ
```yaml
# glance.yml
- type: extension
  url: http://localhost:8082/
  allow-potentially-dangerous-html: true
  cache: 5m
```

### Docker éƒ¨ç½²
```bash
# æ„å»ºé•œåƒ
docker build -t glance-bilibil .

# è¿è¡Œå®¹å™¨
docker run -d \
  --name glance-bilibil \
  -p 8082:8082 \
  -v $(pwd)/config:/config \
  glance-bilibil
```

---

## ğŸ”§ æŠ€æœ¯æ ˆ

| ç»„ä»¶ | æŠ€æœ¯ |
|------|------|
| è¯­è¨€ | Go 1.21+ |
| Webæ¡†æ¶ | Gin (æ–°å¢) |
| HTTPå®¢æˆ·ç«¯ | Resty v2 (è¿æ¥æ±  + é‡è¯•) |
| æ—¥å¿— | Uber Zap (é«˜æ€§èƒ½ç»“æ„åŒ–æ—¥å¿—) |
| æ¨¡æ¿ | Go Template (embed) |
| é‰´æƒ | WBI ç­¾å |
| å¹¶å‘ | Worker Pool (10 workers) |
| æµ‹è¯• | Go Testing (å•å…ƒæµ‹è¯•è¦†ç›–æ ¸å¿ƒé€»è¾‘) |

---

## ğŸ§ª å•å…ƒæµ‹è¯•

### æµ‹è¯•è¦†ç›–èŒƒå›´
- **Models**: `VideoList` çš„æ’åºä¸åˆ‡ç‰‡é€»è¾‘ã€‚
- **Worker**: Worker Pool çš„å¹¶å‘æ‰§è¡Œã€ç”Ÿå‘½å‘¨æœŸç®¡ç†ä¸é”™è¯¯å®¹é”™ã€‚
- **Platform (WBI)**: ç­¾åç®—æ³•æ­£ç¡®æ€§åŠç‰¹æ®Šå­—ç¬¦è¿‡æ»¤é€»è¾‘ã€‚
- **API (Handler)**: ç›¸å¯¹æ—¶é—´è®¡ç®—é€»è¾‘ã€‚

---

## ğŸ“¡ API ç«¯ç‚¹

| ç«¯ç‚¹ | æ–¹æ³• | æè¿° |
|------|------|------|
| `/` | GET | HTML Widgetï¼ˆä¾› Glance åµŒå…¥ï¼‰|
| `/json` | GET | JSON æ ¼å¼çš„æ’åºè§†é¢‘åˆ—è¡¨ |
| `/help` | GET | å¸®åŠ©/è¯´æ˜é¡µ |
| `/health` | GET | å¥åº·æ£€æŸ¥ |

**å‚æ•°**ï¼š
| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| limit | 25 (flag) | æ˜¾ç¤ºè§†é¢‘æ•°é‡ |
| style | horizontal-cards | æ ·å¼: horizontal-cards/grid-cards/vertical-list |
| mid | - | ä¸´æ—¶æŒ‡å®šå•ä¸ª UP ä¸» |
| cache | 300 | ç¼“å­˜æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œ0 ä¸ºç¦ç”¨ |
| collapse-after | 7 | å‚ç›´åˆ—è¡¨æŠ˜å é˜ˆå€¼ |
| collapse-after-rows | 4 | ç½‘æ ¼å¸ƒå±€æŠ˜å è¡Œæ•°é˜ˆå€¼ |

---

## ğŸŒ å¤–éƒ¨ API

é¡¹ç›®ä¸»è¦ä¾èµ–ä»¥ä¸‹ Bilibili å®˜æ–¹æ¥å£ï¼š

| æ¥å£ç”¨é€” | æ–¹æ³• | URL | å¤‡æ³¨ |
|----------|------|-----|------|
| è·å–éªŒè¯å‚æ•° | GET | `https://api.bilibili.com/x/frontend/finger/spi` | è·å– `buvid3/4` |
| è·å– WBI å¯†é’¥ | GET | `https://api.bilibili.com/x/web-interface/nav` | è·å– `img_key` å’Œ `sub_key` |
| è·å– WebID | GET | `https://space.bilibili.com/{mid}/dynamic` | ä» HTML è§£æ `w_webid` |
| è·å–è§†é¢‘åˆ—è¡¨ | GET | `https://api.bilibili.com/x/space/wbi/arc/search` | æ ¸å¿ƒæ¥å£ï¼Œéœ€ WBI ç­¾å |

---

## ğŸ¯ è®¾è®¡æ¨¡å¼ä¸ä¼˜åŒ–

### é£æ§è§£å†³æ–¹æ¡ˆ
ä¸ºé€šè¿‡ Bilibili çš„é£æ§æ£€æµ‹ï¼Œå®ç°äº†ä»¥ä¸‹æœºåˆ¶ï¼š
- **buvid cookie**: ä» `/x/frontend/finger/spi` æ¥å£åŠ¨æ€è·å–
- **dm å‚æ•°**: æ¨¡æ‹Ÿæµè§ˆå™¨è¡Œä¸º
- **w_webid**: ä»ç”¨æˆ·ç©ºé—´é¡µé¢è§£æè·å–

### HTTP ä¼˜åŒ–ï¼ˆæ–°å¢ï¼‰
**å…¨å±€å•ä¾‹ Resty å®¢æˆ·ç«¯** (`internal/platform/http_client.go`)
- **è¿æ¥æ± é…ç½®**
  - `MaxIdleConns`: 100 ï¼ˆæœ€å¤§ç©ºé—²è¿æ¥ï¼‰
  - `MaxIdleConnsPerHost`: 10 ï¼ˆæ¯ä¸ª Host æœ€å¤§ç©ºé—²è¿æ¥ï¼‰
  - `IdleConnTimeout`: 90s ï¼ˆç©ºé—²è¿æ¥è¶…æ—¶ï¼‰
- **æ™ºèƒ½é‡è¯•ç­–ç•¥**
  - é‡è¯•æ¬¡æ•°: 3 æ¬¡
  - é‡è¯•ç­‰å¾…: 1s - 5s ï¼ˆæŒ‡æ•°é€€é¿ï¼‰
  - é‡è¯•æ¡ä»¶: ç½‘ç»œé”™è¯¯ã€5xx é”™è¯¯ã€429 é™æµ
- **ä¼˜åŠ¿**: TCP è¿æ¥å¤ç”¨ï¼Œå‡å°‘æ¡æ‰‹å¼€é”€ï¼Œæå‡æ€§èƒ½

### å¹¶å‘å¤„ç†ï¼ˆä¼˜åŒ–ï¼‰
**Worker Pool æ¨¡å¼** (`internal/worker/pool.go`)
- é»˜è®¤ 10 ä¸ª Workerï¼Œé™åˆ¶å¹¶å‘æ•°é‡
- ä»»åŠ¡é˜Ÿåˆ—ç¼“å†²ï¼šWorker æ•°é‡çš„ 2 å€
- **ä¼˜åŠ¿**: é˜²æ­¢çªå‘æµé‡è€—å°½ç³»ç»Ÿèµ„æº
- **åº”ç”¨åœºæ™¯**: Service å±‚è·å–å¤šä¸ª UP ä¸»è§†é¢‘

**åŸæœ‰å¹¶å‘æœºåˆ¶**
- ä½¿ç”¨ goroutine å¹¶å‘è·å–å¤šä¸ª UP ä¸»çš„è§†é¢‘
- WaitGroup åŒæ­¥ï¼Œchannel æ”¶é›†ç»“æœ
- å•ä¸ªå¤±è´¥ä¸å½±å“å…¶ä»– UP ä¸»

---

## ğŸ“ ç›®å½•ç»“æ„
```
glance-bilibil/
â”œâ”€â”€ main.go                    # å…¥å£
â”œâ”€â”€ config/                    # é…ç½®ç›®å½•
â”‚   â””â”€â”€ config.json            # é…ç½®æ–‡ä»¶
â”œâ”€â”€ go.mod                     # Go æ¨¡å—
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ api/handler.go         # HTTP å¤„ç†å™¨
â”‚   â”œâ”€â”€ config/config.go       # é…ç½®åŠ è½½
â”‚   â”œâ”€â”€ models/models.go       # æ•°æ®ç»“æ„
â”‚   â”œâ”€â”€ platform/
â”‚   â”‚   â”œâ”€â”€ bilibili.go        # Bilibili å®¢æˆ·ç«¯
â”‚   â”‚   â”œâ”€â”€ wbi.go             # WBI ç­¾å
â”‚   â”‚   â””â”€â”€ http_client.go     # HTTP å®¢æˆ·ç«¯ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ service/
â”‚   â”‚   â””â”€â”€ video_service.go   # ä¸šåŠ¡é€»è¾‘
â”‚   â””â”€â”€ worker/
â”‚       â””â”€â”€ pool.go            # Worker Poolï¼ˆæ–°å¢ï¼‰
â”œâ”€â”€ templates/                 # HTML æ¨¡æ¿
â”‚   â”œâ”€â”€ videos.html
â”‚   â”œâ”€â”€ videos-grid.html
â”‚   â”œâ”€â”€ videos-list.html
â”‚   â””â”€â”€ video-card.html
â””â”€â”€ doc/                       # å‚è€ƒæ–‡æ¡£
```

---

## ğŸ“Š å¼€å‘çŠ¶æ€

### å·²å®Œæˆ
- [x] åˆ†å±‚æ¶æ„è®¾è®¡
- [x] å¤š UP ä¸»é…ç½®æ”¯æŒ
- [x] å¹¶å‘è·å–ä¸æ—¶é—´æ’åºæ±‡æ€»
- [x] WBI ç­¾åä¸é£æ§ç»•è¿‡
- [x] ä¸‰ç§å±•ç¤ºæ ·å¼
- [x] é…ç½®æ–‡ä»¶æ”¯æŒ
- [x] **HTTP è¿æ¥æ± ä¼˜åŒ–**ï¼ˆ2026-01-21ï¼‰
- [x] **Worker Pool å¹¶å‘æ§åˆ¶**ï¼ˆ2026-01-21ï¼‰
- [x] **æ™ºèƒ½é‡è¯•ç­–ç•¥**ï¼ˆ2026-01-21ï¼‰
- [x] **æ ¸å¿ƒæ¨¡å—å•å…ƒæµ‹è¯•**ï¼ˆ2026-01-21ï¼‰
  - å®ç° Models, Worker, WBI ç­‰æ¨¡å—æµ‹è¯•
  - ä¿®å¤ WBI ç‰¹æ®Šå­—ç¬¦è¿‡æ»¤ Bug
- [x] **GitHub Action è‡ªåŠ¨åŒ–æµ‹è¯•**ï¼ˆ2026-01-21ï¼‰
  - åœ¨ CI ä¸­é›†æˆå•å…ƒæµ‹è¯•æµç¨‹ï¼Œå®ç°ä»£ç æäº¤æ—¶è‡ªåŠ¨è¿è¡Œæµ‹è¯•
  - **ä»»åŠ¡æ¨¡å—åŒ–**ï¼šæ‹†åˆ†ä¸º Lint, Test, Build, Docker å››ä¸ªå¹¶è¡Œ Job
  - **Lint æ£€æŸ¥**ï¼šç‹¬ç«‹è¿è¡Œä»£ç æ ¼å¼æ£€æŸ¥ (gofmt) å’Œé™æ€åˆ†æ (go vet)
  - **Docker æ„å»º**ï¼šCI ä¸­å¢åŠ  Docker Image æ„å»ºéªŒè¯
- [x] **é«˜æ€§èƒ½ç»“æ„åŒ–æ—¥å¿—ç³»ç»Ÿ**ï¼ˆ2026-01-21ï¼‰
  - ä½¿ç”¨ Uber Zap æ›¿æ¢æ ‡å‡†åº“ log
  - ç¯å¢ƒè‡ªåŠ¨æ£€æµ‹ï¼šå¼€å‘æ¨¡å¼ï¼ˆé«˜äº® Console + Debugï¼‰/ ç”Ÿäº§æ¨¡å¼ï¼ˆJSON + Infoï¼‰
  - æ™ºèƒ½é»˜è®¤å€¼ï¼š`go run` å¯åŠ¨ Debug çº§åˆ«ï¼Œç¼–è¯‘å/Docker Info çº§åˆ«
  - ç»“æ„åŒ–å­—æ®µï¼šè‡ªåŠ¨æºå¸¦ UPä¸»åç§°ã€IDã€ç¼“å­˜çŠ¶æ€ç­‰ä¸Šä¸‹æ–‡

### å¾…åŠ
- [x] Docker æ”¯æŒï¼ˆ2026-01-21ï¼‰
- [ ] Glance é›†æˆæµ‹è¯•

---

## ğŸ”® å¼€å‘è§„èŒƒ

### ä»£ç è§„èŒƒ
- æ‰€æœ‰å…¬å¼€å‡½æ•°å¿…é¡»æ·»åŠ æ³¨é‡Š
- é”™è¯¯å¤„ç†ä½¿ç”¨ Go æ ‡å‡†é”™è¯¯æ¨¡å¼
- æ—¥å¿—ä½¿ç”¨ `logger.Info/Warn/Error` ç­‰æ–¹æ³•ï¼Œé‡è¦ä¸šåŠ¡é€»è¾‘ä½¿ç”¨ `logger.Infow/Warnw/Errorw` æºå¸¦ä¸Šä¸‹æ–‡å­—æ®µ

### æ—¥å¿—ä½¿ç”¨è§„èŒƒ
**ç»“æ„åŒ–æ—¥å¿—æ–¹æ³•**ï¼ˆæ¨èç”¨äºä¸šåŠ¡é€»è¾‘ï¼‰ï¼š
```go
logger.Infow("è·å–è§†é¢‘æˆåŠŸ",
    "up_name", channel.Name,
    "up_mid", channel.Mid,
    "video_count", len(videos),
    "cached", false,
)
```

**æ™®é€šæ—¥å¿—æ–¹æ³•**ï¼š
```go
logger.Info("æœåŠ¡å¯åŠ¨æˆåŠŸ", zap.String("port", port))
```

### æ·»åŠ æ–°åŠŸèƒ½
1. æ¨¡å‹å±‚ï¼šåœ¨ `internal/models/` æ·»åŠ æ•°æ®ç»“æ„
2. å¹³å°å±‚ï¼šåœ¨ `internal/platform/` æ·»åŠ  API å®¢æˆ·ç«¯
3. æœåŠ¡å±‚ï¼šåœ¨ `internal/service/` æ·»åŠ ä¸šåŠ¡é€»è¾‘
4. API å±‚ï¼šåœ¨ `internal/api/` æ·»åŠ å¤„ç†å™¨
